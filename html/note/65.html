<!doctype html><title>妹blog近期的优化总结 2014 - 代码 - 卜卜口</title><meta name=viewport content=width=device-width,user-scalable=0><link rel=stylesheet href=/static/css/index.css?suffix=1hlsbpv><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=black-translucent><link rel=apple-touch-icon-precomposed href=/static/img/projects/mouto.org-icon.svg><link rel=alternate type=application/rss+xml title="卜卜口 RSS 2.0" href=/rss.xml.xml><link rel=manifest href=/manifest.json crossorigin=use-credentials><header><nav><a href=/ ><b>卜卜口</b></a><a href=/projects><b>项目</b></a><a href=/photos?star=1><b>写真</b></a><a href=/notes class=active><b>笔记</b></a><a href=/links><b>链接</b></a></nav></header><div id=M><div class=view-box view=note><div class="article-single-box layout"><div class=head><h1>妹blog近期的优化总结 2014</h1><p><a href=/ class=user-link><img src=/static/img/avatar.jpg>卜卜口</a><a href=/photos?type=code>代码</a><time datetime="2014-01-13 17:05:45">2014-1-13</time></div><div class=content><div class=content-image><img src=&#x2F;&#x2F;sinaimg.sojo.im:233&#x2F;mw1024&#x2F;a15b4afejw1eci03i4b8pj21kw11xan9></div><p><del>自从写了新的博客程序之后，好像又开始熬夜了OAQ 今天爸爸出院，不用再每天去医院照顾 考虑尽快将这个博客程序完善起来发布出去。（感觉快不起来呢</del><br><span class=br></span> 很久之前从 还在用yo2免费wordpress博客托管 时就有计划写个自己的blog程序，之后也确实写过了不少个不一样的雏形，类论坛、类微博、类轻博客、一句话、依托于浏览器的本地单页应用...等等等但每个最后都因为没法满足自己而废弃，所以这次在开始码代码之前企划的时候、做了很多前期准备，画了不少各式各样的想要的博客样式、画了不少常见的图标<del>意义何在</del>，最后还是有些用处的OAQ（比如保留很多绘图痕迹的<del>难看的</del>图标...<p>这次的新blog 代号 <b>妹(imouto)</b> ，<del>大概也就是当初换这个域名的原因。为了现在这个子域名OAQ</del>是一切以速度、极简、效率为优先的<del>一看就是程序员的</del>博客程序，托管选择了静态资源访问起来飞快的<a href=http://www.hostker.com/ rel="external nofollow noreferer" class=link target=_blank>http://www.hostker.com/</a> 基友维护的比较安心OAQ<del>不像某些App Engine</del>有问题可以随时沟通，而且维护很勤快<del>所以经常被攻击T_T</del><p>前言好长，自从用上微博好久没写这么多字了（<h2>静态化</h2><p>静态化是提速的关键，玩过blog的肯定都接触过wordpress，他的肿胀用过的肯定都体验过一番。<br><span class=br></span> 在我的旧博客<a href=http://mouto.org/ rel="external nofollow noreferer" class=link target=_blank>http://mouto.org/</a>上我也做过很多优化，各种方法也都尝试过 但始终不理想。php运行时间始终可怕。<p>一般的blog在访问时都要在后端进行sql操作，循环模版，调用插件处理数据，输出html内容返回给浏览者。<br><span class=br></span> 静态化之后直接跳过这步骤，访问->返回<p>妹blog在访问时，所有载入资源都实现了静态化。再记录下实现静态化之后的一些必要优化：<p>静态化资源务必返回缓存头（最后更新时间or缓存时间），这样能在即保持内容及时更新的同时加速二次载入时的速度<br><span class=br></span> 设置缓存头时务必附带（Accept-Ranges 和 Content-Length)<blockquote><p>如果搭建在hostKer直接在后台网站性能优化里面开启缓存头选项即可～（via. 小新）</blockquote><h3>JSON传输数据配合hash实现换页不刷新（兼容旧浏览器）</h3><p>JSON传输数据这个没什么需要说的啦，只记录些让数据更精简的技巧：<br><span class=br></span> 在格式可控、前端代码可控的情况下尽量使用没定义下标的数组传输内容，字节数会小挺可观的量；<br><span class=br></span> 生成JSON时中文字符不转换成uAAAA 形式的UTF码，斜线之类的标点不用加反斜杠；<p>hash实现换页不刷新算是我用过比较多的技巧了、单页保留浏览进度还算不错的方法，偷揉电台 <a href=http://itorr.sinaapp.com/fm/ rel="external nofollow noreferer" class=link target=_blank>http://itorr.sinaapp.com/fm/</a> 、杂货物讨论版 <a href=http://za2.org/ rel="external nofollow noreferer" class=link target=_blank>http://za2.org/</a> 、萌电台 <a href=http://moe.re/fm rel="external nofollow noreferer" class=link target=_blank>http://moe.re/fm</a> 等等都是利用这个技术实现单页不刷新。<p>监控window的popstate事件响应页面变动操作，之后访问 #act 这样的参数url就可以不跳转页面实现内容刷新。页面需要传输多个参数时可以在hash里按照 #!act/参数1/参数2 这样的结构来实现，响应时 根据获取到hash、去除不需要的字串、其余按照’/‘进行分割<pre><code>location.hash.substring(2).split(&#39;/&#39;) 
</code></pre><p>但是旧的浏览器无法响应popstate事件，这时我们就要利用setInterval每隔一段时间检测url改动，实测100毫秒检测一次IE6表现良好。<pre><code>if(!history.pushState){//判断浏览器不支持popstate事件 
 var laHash=0,//记录历史url 
 setInterval(function(){//设定循环运行 
 if(laHash!=location.hash){ //判断url更新 
 popstate();//运行事件 
 laHash=location.hash;//记录新的历史url 
 } 
 },100); //100毫秒运行一次 
} 
</code></pre><h2>功能增多的前提下 代码颗粒化 按需加载</h2><p>从一开始的只能加载首页和文章数据到现在在blog上实现了各种<del>还算好玩的</del>常见功能，代码量成倍增加、只通过两条请求加载js和css很容易堵塞首次浏览时的页面显示速度，这时候就要果断把各部分功能不同的代码分开颗粒化，只有需要某部分代码时才进行加载。加载过的就缓存在浏览器进程里（甚至可以缓存到本地）<h2>精简代码 合理重构 代码重用 相同内容不多次加载</h2><p>这4条放在一起是因为都只关于两段函数的优化 那就是 $.x() ajax部分 和$.lcss()部分<br><span class=br></span> 在上一个版本里，blog的缓存机制还是写在blog函数里，每个页面利用不同方式进行缓存，很不用好。所以这个版本对这里进行了推翻重做，直接在ajax函数和插入css函数上进行缓存，<br><span class=br></span> 记录每次请求的地址，相同内容直接返回、不再发请求给后端。只要是打开过的页面，在下一次访问会立刻开启。<p>$.x的话因为要储存载入过来的json数据，实现肯定是越简单好用的好、建立一个object 碰到载入就存起来 下次请求url时判断如果载入过就直接返回<pre><code class=JavaScript>$.x=function(A){//建立一个为A的object 
 return function(i,p,f,e,x){ 
 if(typeof p==&#39;function&#39;){e=f;f=p;p=0};//处理传入参数 
 if(A[i])return f(A[i]);如果载入的url已存在那么直接callback返回 
 /*下面一堆处理ajax的代码*/ 
 (x=win.XMLHttpRequest?new XMLHttpRequest():new ActiveXObject(&#39;Microsoft.XMLHTTP&#39;)).open(p?&#39;POST&#39;:&#39;GET&#39;,i,1); 
 x.setRequestHeader(&#39;Content-Type&#39;,&#39;application/x-www-form-urlencoded&#39;); 
 if(f||e)x.onreadystatechange=function(){ 
 if(x.readyState==4)((x.status&gt;199&amp;&amp;x.status&lt;301)||x.status==304)?f(A[i]=i.match(/.json$/)?JSON.parse(x.responseText):x.responseText):e(x.status)//载入成功那么根据url缓存起来～ 
 }; 
 x.send(p||&#39;&#39;); 
 return x 
 } 
}({}); 
</code></pre><p>加载css文件的话就简单了，因为不需要多次回调、只需确保样式载入过不多次加载即可。直接用字符串保存载入过的url，下次加载时做一下判断即可。<br><span class=br></span> 代码在<a href=http://i.mouto.org/c.js rel="external nofollow noreferer" class=link target=_blank>http://i.mouto.org/c.js</a> 的37行 $.lcss<h2>关于多说评论 以及 缓存外部数据到博客（定时更新</h2><p>妹blog在企划是就在纠结，评论部分怎么办。自己来做的话很多社区化的圈子没办法做<del>除非自己写个社区化评论插件让一堆人用</del>，权衡了之后还是只能选择用的人比较多的多说，没办法、社区化的圈子自己一定是无能为力，优化多说之前也写过文章<a href=http://mouto.org/53943 rel="external nofollow noreferer" class=link target=_blank>http://mouto.org/53943</a> <del>还被某博客盗文章改成他的不加来源。。。</del>，无外乎上面提到的按需加载，直接利用多说的json API能不用它的js就不用。因为他的js实在是。。。T<em>T不好用<br><span class=br></span> 简单总结下调教多说的一些记录吧，之前提到的只在需要多说评论时加载和不用多说的js实现显示最新评论在<a href=http://mouto.org/53943 rel="external nofollow noreferer" class=link target=_blank>http://mouto.org/53943</a> 有总结和给出代码就不再重复，<br><span class=br></span> 这里说下之前没总结过的。<br><span class=br></span> 一般利用多说都是每次打开页面时载入一次多说的js、遇到多说标记的div进行替换，在一般的每打开页面都刷新的网页上这样没什么太大问题<del>包含且不只 速度慢、载入资源多、影响页面渲染、载入过程难看、影响其他资源载入</del>，但是在ajax加载文章的情况下自带的js根本无法工作T</em>T 给多说提建议人家闲烦：我这就不提供这种、怎么就你需要呢？没必要，等更新吧。 嗯，这就是多说。<del>基本就是这个意思。</del><p>为了能让ajax调用的情况下不重复载入多说肿胀的js 也能加载评论框的代码，提前准备好多说的div然后需要载入时运行<pre><code>DUOSHUO.EmbedThread(&#39;.ds-thread&#39;); 
</code></pre><p>评论部分先这样应付。等有时间把多说的js重写<h3>继续优化多说 最新评论 和 最新访客</h3><p>接下来是继续优化之前优化过的显示最新评论 和 显示最新访客<br><span class=br></span> 即使直接调用多说的json，依旧慢T_T 多说的后端不知道是如何实现的居然能做到如此慢。慢。慢。慢。<p>为了追求速度，用服务器定时缓存多说的json到本地进行静态化缓存。<br><span class=br></span> 提供一下php的代码参考<pre><code>&lt;?php 
function get($i,$t=60){ 
 $c=curl_init(); 
 curl_setopt($c,CURLOPT_URL,$i); 
 curl_setopt($c,CURLOPT_TIMEOUT,$t); 
 curl_setopt($c,CURLOPT_RETURNTRANSFER,TRUE); 
 $f=curl_exec($c); 
 return $f; 
} 

file_put_contents(‘写入的json文件名.json’,get(&#39;http://你的多说id.duoshuo.com/api/sites/listRecentPosts.json?show_admin=是否显示管理员评论(0or1)&amp;show_title=是否显示标题(0or1)&amp;excerpt_length=字符数限制&amp;num_items=加载的最新评论数量&#39;)); 
</code></pre><p>定时运行的话，SAE BAE都有类似的<br><span class=br></span> SAE BAE之类的Cron可以参考 <a href="http://sae.sina.com.cn/?m=devcenter&amp;catId=195" rel="external nofollow noreferer" class=link target=_blank>http://sae.sina.com.cn/?m=devcenter&amp;catId=195</a><p>如果托管的环境没有定时运行服务提供，找时间总结下身边人用过的各种黑科技OwQ<h2>统一图标</h2><p>老生常谈，无非什么 CSS雪碧。妹blog在企划之初 计划全站只用一套ICON在各处，也算是优化里面的一步吧<h2>博客使用图像托管</h2><p>一般玩blog的图像基本都是放在其他一些图像托管上，节省流量、加快访问速度。<br><span class=br></span> 妹blog也不例外，既然在国内当然要用本土服务。<p>没有外链限制、流量限制、没有传图限制、可以没有水印、提供不同尺寸、提供压缩、各地CDN...<p>哈哈哈这不就是在说新浪微博么OwQ<p>配合之前写的 <a href=http://disu.sinaapp.com/ rel="external nofollow noreferer" class=link target=_blank>http://disu.sinaapp.com/</a> 偷揉图床API 还算好用OwQ<h2>备上案走国内路线。。。</h2><p>hostker对于已备案的域名可以不用走香港路线，之前一直不知道T_T 换成国内一下速度提升好多OAQ<del>明显在凑数。</del><p>差不多就是这些，还有不少细节上的等下次感觉可以分享的时候再总结吧。好久没有打这么多字了，遇到什么问题评论和QQ之类的联系我都可以OwQ</div><div class=cm-article data-key=v3|65></div></div></div></div><script src=/static/js/build.js?suffix=1hlsbpv></script>